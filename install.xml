<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Factoring 0-0-4</name>
    <code>factoring004</code>
    <version>3.x</version>
    <author>BNPL partners</author>
    <link>http://example.com</link>

    <file path="catalog/controller/api/order.php">
        <operation>
            <search>
                <![CDATA[
                    <?php
                ]]>
            </search>
            <add position="after" action="insert" offset="0">
                <![CDATA[
                    require_once DIR_SYSTEM . 'library/factoring004/vendor/autoload.php';
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/controller/api/order.php">
        <operation>
            <search>
                <![CDATA[
                    $this->model_checkout_order->editOrder($order_id, $order_data);
                ]]>
            </search>
            <add position="before" action="insert" offset="0">
                <![CDATA[
                    // send and check otp
                    $managerResponse = \BnplPartners\Factoring004Payment\OrderManager::create($this->registry)
                        ->handle($order_info, $this->request->post);

                    if ($managerResponse->isProcessed()) {
                        $json['otp'] = $managerResponse->isSentOtp();
                        $json['return'] = $managerResponse->isReturn();

                        if (!$managerResponse->isSuccess()) {
                            $json['error'] = $managerResponse->getMessage();
                            $this->response->addHeader('Content-Type: application/json');
                            $this->response->setOutput(json_encode($json));
                            return;
                        }

                        if ($managerResponse->isSentOtp()) {
                            $json['success'] = $managerResponse->getMessage();
                            $this->response->addHeader('Content-Type: application/json');
                            $this->response->setOutput(json_encode($json));
                            return;
                        }
                    }
                ]]>
            </add>
        </operation>
    </file>

    <file path="admin/controller/sale/order.php">
        <operation>
            <search>
                <![CDATA[
                    $this->response->setOutput($this->load->view('sale/order_form', $data));
                ]]>
            </search>
            <add position="before" action="insert" offset="0">
                <![CDATA[
                    $this->load->language('extension/payment/factoring004');
                    $data['factoring004_return_status_id'] = $this->config->get('payment_factoring004_return_order_status_id');
                    $data['text_return_amount'] = $this->language->get('text_return_amount');
                    $data['text_return_enter_amount'] = $this->language->get('text_return_enter_amount');
                    $data['text_return_amount_helper'] = $this->language->get('text_return_amount_helper');
                    $data['text_return_button'] = $this->language->get('text_return_button');
                    $data['text_check_otp_title'] = $this->language->get('text_check_otp_title');
                    $data['text_check_otp_enter_otp'] = $this->language->get('text_check_otp_enter_otp');
                    $data['text_check_otp_button'] = $this->language->get('text_check_otp_button');
                ]]>
            </add>
        </operation>
    </file>

    <file path="admin/controller/sale/order.php">
        <operation>
            <search>
                <![CDATA[
                    $this->response->setOutput($this->load->view('sale/order_info', $data));
                ]]>
            </search>
            <add position="before" action="insert" offset="0">
                <![CDATA[
                    $this->load->language('extension/payment/factoring004');
                    $data['factoring004_return_status_id'] = $this->config->get('payment_factoring004_return_order_status_id');
                    $data['text_return_amount'] = $this->language->get('text_return_amount');
                    $data['text_return_enter_amount'] = $this->language->get('text_return_enter_amount');
                    $data['text_return_amount_helper'] = $this->language->get('text_return_amount_helper');
                    $data['text_return_button'] = $this->language->get('text_return_button');
                    $data['text_check_otp_title'] = $this->language->get('text_check_otp_title');
                    $data['text_check_otp_enter_otp'] = $this->language->get('text_check_otp_enter_otp');
                    $data['text_check_otp_button'] = $this->language->get('text_check_otp_button');
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/controller/api/order.php">
        <operation>
            <search>
                <![CDATA[
                    $this->model_checkout_order->addOrderHistory($order_id, $this->request->post['order_status_id'], $this->request->post['comment'], $this->request->post['notify'], $this->request->post['override']);
                ]]>
            </search>
            <add position="before" action="insert" offset="0">
                <![CDATA[
                    // send and check otp
                    $managerResponse = \BnplPartners\Factoring004Payment\OrderManager::create($this->registry)
                        ->handle($order_info, $this->request->post);

                if ($managerResponse->isProcessed()) {
                    $json['otp'] = $managerResponse->isSentOtp();
                    $json['return'] = $managerResponse->isReturn();

                    if (!$managerResponse->isSuccess()) {
                        $json['error'] = $managerResponse->getMessage();
                        $this->response->addHeader('Content-Type: application/json');
                        $this->response->setOutput(json_encode($json));
                        return;
                    }

                    if ($managerResponse->isSentOtp()) {
                        $json['success'] = $managerResponse->getMessage();
                        $this->response->addHeader('Content-Type: application/json');
                        $this->response->setOutput(json_encode($json));
                        return;
                    }
                }
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/view/theme/default/template/checkout/payment_method.tpl">
        <operation>
            <search>
                <![CDATA[
                <?php if ($payment_method['code'] == $code || !$code) { ?>
                ]]>
            </search>
            <add position="before" action="insert">
                <![CDATA[
                    <?php $isEnabled = true; ?>
                    <?php if ($payment_method['code'] == 'factoring004') { ?>
                        <?php $isEnabled = $payment_method['isAvailable']; ?>
                    <?php } ?>
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/view/theme/default/template/checkout/payment_method.tpl">
        <operation>
            <search>
                <![CDATA[
                <input type="radio" name="payment_method" value="<?php echo $payment_method['code']; ?>" checked="checked" />
                ]]>
            </search>
            <add position="replace" action="insert">
                <![CDATA[
                <input type="radio" name="payment_method" value="<?php echo $payment_method['code']; ?>" <?php echo !$isEnabled ? 'disabled="disabled"' : 'checked="checked"'?>/>
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/view/theme/default/template/checkout/payment_method.tpl">
        <operation>
            <search>
                <![CDATA[
                <input type="radio" name="payment_method" value="<?php echo $payment_method['code']; ?>" />
                ]]>
            </search>
            <add position="replace" action="insert">
                <![CDATA[
                <input type="radio" name="payment_method" value="<?php echo $payment_method['code']; ?>" <?php echo !$isEnabled ? 'disabled="disabled"' : ''?>/>
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/view/theme/default/template/checkout/payment_method.tpl">
        <operation>
            <search>
                <![CDATA[
                </label>
                ]]>
            </search>
            <add position="before" action="insert">
                <![CDATA[
                <?php if ($payment_method['code'] == 'factoring004' && !$isEnabled) { ?>
                    <p style="color:red"><?php echo $payment_method['availableText']?></p>
                <?php } ?>
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/controller/checkout/payment_method.php">
        <operation>
            <search>
                <![CDATA[
                    $this->response->setOutput($this->load->view('checkout/payment_method', $data));
                ]]>
            </search>
            <add position="before" action="insert">
                <![CDATA[
                    if (!isset($data['payment_methods']['factoring004'])) {
                        $data['factoring004Total'] = 0;
                    } else {
                        $totals = array();
			            $taxes = $this->cart->getTaxes();
			            $total = 0;

                        $total_data = array(
                            'totals' => &$totals,
                            'taxes'  => &$taxes,
                            'total'  => &$total
                        );

                        $this->load->model('extension/extension');

                        $sort_order = array();

                        $results = $this->model_extension_extension->getExtensions('total');

                        foreach ($results as $key => $value) {
                            $sort_order[$key] = $this->config->get($value['code'] . '_sort_order');
                        }

                        array_multisort($sort_order, SORT_ASC, $results);

                        foreach ($results as $result) {
                            if ($this->config->get($result['code'] . '_status')) {
                                $this->load->model('extension/total/' . $result['code']);

                                // We have to put the totals in an array so that they pass by reference.
                                $this->{'model_extension_total_' . $result['code']}->getTotal($total_data);
                            }
                        }
                        $data['factoring004Total'] = (int) ceil($total);
                    }
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/controller/checkout/checkout.php">
        <operation>
            <search>
                <![CDATA[
                    $data['header']
                ]]>
            </search>
            <add position="before" action="insert">
                <![CDATA[
                    $data['factoring004Enabled'] = (bool) $this->config->get('factoring004_status');
                    if ($this->config->get('factoring004_payment_gateway_type') === 'modal') {
                         $data['factoring004PaymentWidgetLink'] = \BnplPartners\Factoring004Payment\ModalWidgetUrlResolver::create($this->registry)->resolve();
                    } else {
                        $data['factoring004PaymentWidgetLink'] = false;
                    }
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[
                     <?php
                 ]]>
            </search>
            <add position="after" action="insert" offset="0">
                <![CDATA[
                     require_once DIR_SYSTEM . 'library/factoring004/vendor/autoload.php';
                 ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/view/theme/default/template/checkout/checkout.tpl">
        <operation>
            <search>
                <![CDATA[
                    <?php echo $header; ?>
                ]]>
            </search>
            <add position="before" action="insert">
                <![CDATA[
                    <?php if ($factoring004Enabled): ?>
                        <? if ($factoring004PaymentWidgetLink): ?>
                             <script src="<?=$factoring004PaymentWidgetLink ?>"></script>
                        <? endif ?>
                    <?php endif ?>
                ]]>
            </add>
        </operation>
    </file>
</modification>
